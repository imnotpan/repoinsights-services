name: commits_in_pr
variables: [project_id, project_id]
metric: >
    WITH
    all_commits AS (
        SELECT
            COUNT(*) AS total_commits
        FROM
            commits
        WHERE
            project_id = %s AND
            created_at BETWEEN '2012-10-03' AND '2013-01-01'
    ),
    linked_commits AS (
        SELECT
            COUNT(DISTINCT c.id) AS linked_commits
        FROM
            commits c
            INNER JOIN pull_request_commits prc ON c.id = prc.commit_id
            INNER JOIN pull_requests pr ON prc.pull_request_id = pr.id
        WHERE
            c.project_id = %s AND
            c.created_at BETWEEN '2012-10-03' AND '2013-01-01'
    )

    SELECT
        all_commits.total_commits,
        linked_commits.linked_commits,
        (linked_commits.linked_commits::numeric / NULLIF(all_commits.total_commits, 0)) * 100 AS linked_commits_percentage
    FROM
        all_commits, linked_commits;

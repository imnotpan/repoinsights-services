name: commits_per_week_last_90_days
description: "Commits per week for the last 90 days"
variables: [project_id, project_id]
metric: >
    WITH commits_90_days AS (
    SELECT 
        project_id,
        author_id,
        COUNT(*) AS num_commits
    FROM 
        commits
    WHERE 
        created_at BETWEEN '2012-10-04' AND '2013-01-01' AND
        project_id = %s
    GROUP BY 
        project_id, author_id
    ), 
    active_weeks AS (
        SELECT 
            project_id, 
            author_id, 
            COUNT(DISTINCT date_trunc('week', created_at)) AS num_weeks
        FROM 
            commits
        WHERE 
            created_at BETWEEN '2012-10-04' AND '2013-01-01' AND
            project_id = %s
        GROUP BY 
            project_id, author_id
    )
    SELECT 
        a.id AS author_id,
        a.name AS author_name,
        COALESCE(c.num_commits, 0) / COALESCE(w.num_weeks, 1) AS avg_commits_per_week
    FROM 
        active_weeks w
        INNER JOIN users a ON w.author_id = a.id
        LEFT JOIN commits_90_days c ON w.author_id = c.author_id AND w.project_id = c.project_id;

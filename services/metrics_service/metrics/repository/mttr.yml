name: mttr
description: Mean time to repair assuming an issue is a failure
measurement: hours
variables: [project_id, project_id]
metric: >
  WITH issue_duration AS (
      SELECT 
          i.repo_id AS project_id,
          i.id AS issue_id, 
          MIN(ie.created_at - i.created_at) AS repair_time
      FROM "ghtorrent_restore_2015"."issues" i
      JOIN "ghtorrent_restore_2015"."issue_events" ie ON i.id = ie.issue_id
      WHERE 
          i.repo_id = %s AND i.pull_request is false
          AND ie.action IN ('closed', 'merged')
      GROUP BY i.repo_id, i.id
  ),

  total_operation_time AS (
      SELECT 
          e.project_id AS project_id,
          MAX(e.date) - MIN(i.created_at) AS operation_time
      FROM "ghtorrent_restore_2015"."issues" i
      JOIN "ghtorrent_restore_2015"."extractions" e ON i.repo_id = e.project_id
      WHERE 
          i.repo_id = %s AND i.pull_request is false
      GROUP BY e.project_id
  )

  SELECT 
      idt.project_id,
      (SUM(EXTRACT(EPOCH FROM idt.repair_time)) / COUNT(idt.issue_id)) / 3600 AS mttr_hours
  FROM issue_duration idt
  JOIN total_operation_time tot ON idt.project_id = tot.project_id
  GROUP BY idt.project_id;
